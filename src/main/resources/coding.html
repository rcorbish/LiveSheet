<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html lang="en">
<head>
<script src='codeBlock.js'></script>
<script src='contextmenu.js'></script>

<style>
.tasks {
	list-style: none;
	margin: 0;
	padding: 0;
}

.task {
	xdisplay: flex;
	justify-content: space-between;
	padding: 12px 0;
	border-bottom: solid 1px #dfdfdf;
}

.task:last-child {
	border-bottom: none;
}

.context-menu {
	display: block;
	position: absolute;
	z-index: 10;
	padding: 12px 0;
	width: 240px;
	background-color: #fff;
	border: solid 1px #dfdfdf;
	box-shadow: 1px 1px 2px #cfcfcf;
}

.context-menu__items {
	list-style: none;
	margin: 0;
	padding: 0;
}

.context-menu__item {
	display: block;
	margin-bottom: 4px;
}

.context-menu__item:last-child {
	margin-bottom: 0;
}

.context-menu__item:hover {
	color: #fff;
	background-color: #0066aa;
}
</style>
</head>

<body>

	<div>
		<div id='toolkit'>
			<canvas width='100' height='600'> </canvas>
		</div>
		<div id='code' class="task">
			<canvas width='600' height='600' style='background:silver;'></canvas>
		</div>
	</div>

	<script>
		var canvas = document.querySelector("#code canvas");
		var canvasWidth = canvas.width;
		var canvasHeight = canvas.height;

		var draggedSprite = null;
		var spriteOffsetX;
		var spriteOffsetY;
		var imageData = null;

		var codeBlockData = [ {
			name : 'XXX',
			type : 'block',
			x : 100,
			y : 100,
			height : 30,
			effectiveHeight : 30,
			width : 250,
			following : [],
			parent : null
		}, {
			name : 'YYY',
			type : 'block',
			x : 20,
			y : 300,
			height : 50,
			effectiveHeight : 50,
			width : 250,
			following : [],
			parent : null
		}, {
			name : 'YYY2',
			type : 'block',
			x : 300,
			y : 300,
			height : 50,
			effectiveHeight : 50,
			width : 250,
			following : [],
			parent : null
		}, {
			name : 'ZZZ',
			type : 'event',
			x : 100,
			y : 400,
			height : 75,
			effectiveHeight : 75,
			width : 250,
			following : [],
			parent : null
		} ];

		var codeBlocks = new CodeBlocks();
		for (var i = 0; i < codeBlockData.length; i++) {
			codeBlocks.add(new CodeBlock(codeBlockData[i]));
		}

		function handleMouseDown(e) {
			if (e.button === 0) {
				var mp = getMousePos(canvas, e);
				// set the drag flag
				draggedSprite = codeBlocks.codeBlockAt(mp.x, mp.y);
				if (draggedSprite) {
					if (draggedSprite.parent) {
						for (var i = 0; i < draggedSprite.parent.following.length; i++) {
							if (draggedSprite === draggedSprite.parent.following[i]) {
								draggedSprite.parent.following.splice(i, 1);
								break;
							}
						}
						var ultimateParent = draggedSprite;
						while (ultimateParent.parent) {
							ultimateParent = ultimateParent.parent;
						}
						ultimateParent.calcHeight();

						draggedSprite.parent = null;
					}
					spriteOffsetX = draggedSprite.x - mp.x;
					spriteOffsetY = draggedSprite.y - mp.y;
					ctx.clearRect(draggedSprite.x, draggedSprite.y,
							draggedSprite.width, draggedSprite.effectiveHeight);

					imgData = null;
					handleMouseMove(e);
				}
			}
		}

		function handleMouseUp(e) {
			if (e.button === 0) {
				if (draggedSprite) {
					var mp = getMousePos(canvas, e);
					draggedSprite.x = mp.x + spriteOffsetX;
					draggedSprite.y = mp.y + spriteOffsetY;
					codeBlocks.testJoin(draggedSprite);
					draggedSprite = null;
					imgData = null;
					redrawAll();
				}
			}
		}

		function handleMouseOut(e) {
			// user has left the canvas, so clear the drag flag
			//isDragging=false;
		}

		function handleMouseMove(e) {
			var mp = getMousePos(canvas, e);
			//console.log( mp.x, ",", mp.y ) ;
			// if the drag flag is set, clear the canvas and draw the image
			if (draggedSprite && e.button === 0) {
				if (imgData) {
					ctx.putImageData(imgData, draggedSprite.x, draggedSprite.y);
				}

				draggedSprite.x = mp.x + spriteOffsetX;
				draggedSprite.y = mp.y + spriteOffsetY;

				imgData = ctx.getImageData(draggedSprite.x, draggedSprite.y,
						draggedSprite.width, draggedSprite.effectiveHeight);

				draggedSprite.draw(ctx);

			}
		}

		function getMousePos(canvas, evt) {
			var rect = canvas.getBoundingClientRect();
			return {
				x : evt.clientX - rect.left,
				y : evt.clientY - rect.top
			};
		}

		canvas.onmousedown = function(e) {
			handleMouseDown(e);
		};
		canvas.oncontextmenu = function(e) {
			handleContextMenu(e);
		};
		canvas.onmousemove = function(e) {
			handleMouseMove(e);
		};
		canvas.onmouseup = function(e) {
			handleMouseUp(e);
		};
		canvas.onmouseout = function(e) {
			handleMouseOut(e);
		};

		var ctx = canvas.getContext("2d");

		function redrawAll() {
			canvas.width = canvas.width; // clear screen
			codeBlocks.draw(ctx);
		}

		redrawAll();
	</script>

</body>

</html>